// The entry file of your WebAssembly module.

const rands: i64[] = [485587621678877,2383166662647561,1559341975590867,8810797469805551,5760306477475591,506210582237545,1314065144313325,1175867599646349,7674400967689897,7932329037237891,947952036553231,2079659406032267,4910668752797721,5282935564081213,8875069826811143,7960318727259113,2321155348119507,3469089919450357,6121422064115169,5200038626736365,3079690636883601,447782322022001,5648175107841353,8146896148001071,7415236968764027,7075362678056499,1762811519743189,6515030800093607,4821233943026647,4750500885567989,1519693803066623,8496341203519073,5196775446967773,7816439691487491,1527223156534645,3707791160669575,1109539694861203,3274128915809959,2047967614506449,3743380808369993,6786393605700221,8888683214747063,7404161692605329,1985561328864767,4247931576732787,7531529655192467,2607338165606697,817461709216377,4612998745209211,1937471169111413,6869992890082437,6289770521384141,6212724690622529,3186195017646125,6712874251976223,1543897732434913,5890168826414577,3112925543531405,3815768749281115,23464700813117,8640313053861763,8910064308011897,843480168774235,1438371403097265,993673829183889,3032368034537379,1192825613784825,3179887677031613,7682973469417989,6229084691341907,6097341489049161,5541096764435895,2778923829239441,1514969151720309,3329568418372833,7175289126784397,8101905456881757,856670108172869,1796183026836101,2511485801407009,2622031627164997,8291511566533985,2140375065959559,123367386449849,426106068018261,6796980960153957,7933341652354113,8548603931450651,1313561216688921,3567206238528603,3673618841575765,659133731440483,5579619815258289,1054902561635127,4619294235819349,4646414918319513,2749549250138951,2196447299758097,2405380546454605,5304896563547987,4901032655333145,7036185991830797,7049623511984919,1982066438493643,5166515359294313,4207436789829787,5610885658617547,1319625268335391,5428274011285525,3332090260915701,631246195577359,80380636105811,8723475746645575,6425744876084429,352636458159443,8306126712863671,1218058918170273,6455193549838115,3060945626959367,834691419367697,3349907114877627,4045166874537467,7807249750304723,2147150327112001,8861506562034081,2262974809183057,986481676050023,5877837744932709,6052979350483511,1299965974685883,34191731388707,7274062823676899,4151585968941479,2364507240125881,3994951244346205,7771689561054711,4707037366206559,4766570669985695,4506121321106531,264643003786185,8181181946568451,5228353328403939,5489907594506479,6854475521225265,6087407421539513,8017724203397161,5166967913605889,1190046656507821,6416767062251557,7509611011068789,1477346657608809,2769303317899979,5447081525653613,361822935533515,2925306267501537,45068535385737,8873358067524181,50005214206755,2377914812401499,6634603479293443,1275021017088805,4553220566363015,1743502869659655,8598519445299449,6269710009591263,7234473564533275,4869984990895099,3326538177045955,4671657738841029,1989481342271763,91175440000267,1860724850664553,6790064082415725,5203665774106943,4499894333025459,7585572845921597,9002452609669537,6474474825206647,3726457701152259,1521040097654807,285702611999381,4087911582706581,1195530310043935,5945240821901505,7969519500826061,3280163258282111,5581805135054043,5074160613747655,8881399608102041,5217924596213543,2472520525087389,4645676432511363,8324166232882853,8522325523235543,4806730459181939,7333026014157903,3084179572509193,3124869890092863,4066944785036987,401158670127405,2817559920975139,1550774678615123,7659705500248317,3596228275578135,3291073325766299,4840133610949777,8284697974773307,5754798500087667,5658676220868253,2551361215798991,4548014324917097,6903922689973413,2226798247833259,414594202769197,2821482550696037,3491337277056171,6444696692348937,7735734382576591,1499135007721843,5674603469063205,6722451894493919,3352275934763089,3235010956607463,3609114043826781,4769592031007257,6225644559752045,2180846998077715,8481374445045679,2796888623607017,2703125658527307,622289297114687,5540660014836157,1947842543525285,7605735798319553,7542018646154649,4801631191434915,7187714283318361,7290285587465923,5254765341101859,4105964235395291,7782525019005175,8744834001155995,2805503147228345,2658025323041023,6747272003777171,5327648574745871,3008065699085901,2373229819311367,3228049427171739,4979999099697967,8829996608055347,5401962832800073,17781584028469,4058708570335377,7755979381465709,1140693448804619,6570222477909611,6631809835733523,7699716569933925,1480615135262473,5446036155981029,6969301121790649,3938443349240447,4077086667362677,3893921984336585,1667312957259105,2732579578532635,2896131011272665,2934578602276033,258516256015005,5559425843546437,6421140587764689,7920057977532561,1528478449352493,3611422901924801,5176086139919801,1408568740554855,8761446871988415,4315782501144499,2522012060824931,6769518061319787,475610226039979,5162983807778599,6273548324560785,385108418784055,436094557901261,3387438990128557,318348769093719,3654735909701037,8912521614801439,746921185153619,8279248482511999,1009220555547893,1205552045155173,1423723771370189,4809800204527459,1309528574350359,2580501063208897,5003824680274247,797032993379213,4709960043946243,5958352539003163,2399465523507131,470823844627951,3675502154435709,2549383255596753,2981363849358263,4628609613511549,4683313214818993,5493682579796591,5480244601328649,5651271425976361,5920456268194745,1062803712220799,8545460493224237,178788657793991,8032817286917663,5125525324296287,2064684527351713,2086075884534963,654159687543699,5059092892642521,8826669328501489,4108874960863017,4611333568231535,1095726590915585,8510175363011135,8576680445480859,2223253570133097,2078206865232629,4768475107680673,5173561038160565,1429879690855503,2854631669683337,5273528267445799,8629842562087305,4619371426836483,8605697669768031,628240326719477,6909454688406089,6026725485735077,877581506639737,2025050816208565,6048439815490581,3254673397621407,5886646004849377,5655079669272719,4170719736841927,3905670089587847,296849960981849,7294772877113707,1181838528426563,6872180866722921,2364085970505695,7201397757118439,4190841151189747,3969391374372045,8441398416740113,6993142364436435,2470938100906693,5498041443163789,3618462419883935,6002220352992811,1658790337921923,1087554016674975,5757889605722571,130910330404343,7199901094972065,8338684524459925,6899674792401615,1724232983235709,3329647272966793,3978704286776869,5708672483043691,3881852364402037,7789912180707987,8304282085210129,2420684863805245,2135002021743425,1838153981174487,1330055998817385,7504653015985901,352486869208211,1799953065822847,4889951006534065,5584399044166405,242443465928857,4877214616354807,1483702518701523,8452331693927269,586150069554513,6781502239795149,1604001697168131,99206161152957,4250537300227657,1366511880142389,5668744793779257,1492654335051507,6042650829645907,1675914150474655,7805933785777513,8888990005884349,5367048821312853,2107975719194231,247742993156173,3586838157896395,1214817039893,5340500790608601,8542878280388745,8677235790116779,6673440433914145,1551055930815945,3567390125631775,2281961262056931,7703262213174321,2009222892759521,7821775654699469,3599600821126503,8285870585013999,5713896913886933,4991700937325939,885284256614927,437393666999465,3260978925560537,276609144135389,6556977191424143,1408628567467049,7149692846108893,3490085593088331,2046279799236257,2752195812948129,374575366752761,1098698115900297,6456049493648111,1271682423111991,6716767475857895,2076212565385041,4460191446219651,4223275961123083,7485450274793171,8274056153895501,7089952655742027,6053679692609477,8046819339534533,226179750945335,8947249147318449,2673676951938169,8668530630881731,6572752498570765,2057498759244467,4717951809266287,2018852083016895,5383037296706877,616474574503217,5460534523747051,8885141074874547,3451003024705479,7031672513115839,1056247062365893,6241868894321533,5247175748498065,2499595147137559,6824230670244963,3541171420185113,1944990511370267,8107842454466203,925218413417181,2493317346077923,851922083385227,8383858507046905,3838227166931573,3386999277317511,211803138432659,2720618223330471,4050717037673825,7412204013244213,5681508370874581,734546140859699,7931679670602153,5199149608905107,6710216167479073,265127437712227,962816384745731,2677750312982261,1088256974920495,2807998201133531,7101200784504645,6192155458133399,5311002949636589,2685110966544509,8473438077164293,1456380015287417,5632817906723285,8159466589962339,1883468193462337,8927887515474005,5846992844897935,5632312718996259,7677848743800807,3388990226724821,1917069977604973,6076730161112047,3501861828258451,3505645372635701,8476719190273487,2657010486260771,7187298630997189,793931756649449,2287644116816355,5123205325000847,6520436182662527,8495374284058407]
const randsl: i32 = rands.length
let randx: i32 = 0

function randi(): i64 {
  const value: i64 = rands[randx % randsl]
  randx++
  return value
}

function randf(): f32 {
  const value: i64 = randi();
  const fvalue: f64 = f64(value) / f64(Number.MAX_SAFE_INTEGER)
  return f32(fvalue)
}

export function add(a: i32, b: i32): i32 {
  return a + b;
}

export function hello(name: string): string {
  var prefix = "Hello, ";
  var suffix = "!";
  return prefix.concat(name).concat(suffix);
}

function saw(f: f32, t: f32): f32 {
  return (((f * t * 1.0) % 1.0) - 0.5) * 1.0; // TODO: I think the `* 1.0` should be a `* 2.0`
}

function noise(): f32 {
  const r: f32 = f32(randf());
  const d: f32 = f32(r * 2.0 - 1.0);
  return d;
}

const pi: f32 = 3.141592654;
const tau: f32 = 2.0 * pi;
const samplerate: f32 = 44100;


function lores(freq: f32, res: f32, input: f32): f32 {
  // const w: f32 = tau * freq / samplerate; // Pole angle
  // const q: f32 = 1.0 - w / (2.0 * (res + 0.5 / (1.0 + w)) + w - 2.0);
  // const r: f32 = q * q;
  // const c: f32 = r + 1.0 - 2.0 * f32(Math.cos(w)) * q;
  // let pos: f32 = 0.0;
  // let speed: f32 = 0.0;
  // speed += (input - pos) * c;
  // pos += speed;
  // speed *= r;
  // let temp: f32 = pos;
  // if (temp > 32767) temp = 32767;
  // if (temp < -32768) temp = 32768;
  // return temp
  return 0.0
}

// TODO: Do something with this buffer state
let buf0: f32 = 0.0
let buf1: f32 = 0.0
function lores2(f: f32, q: f32, input: f32): f32 {
  const f2 = f32(Math.min(f, 0.999))
  const fb: f32 = q + q / (1.0 - f2);
  buf0 = buf0 + f2 * (input - buf0 + fb * (buf0 - buf1));
  buf1 = buf1 + f2 * (buf0 - buf1);
  return buf1
}

function ramp(f: f32, t: f32): f32 {
  return (f * t * 1.0) % 1.0;
}

function tri(p: f32, t: f32): f32 {
  return (t < p) ? t / p : -(t / (1.0 - p)) + (1.0 / (1.0 - p))
}

export function dsp(t: f32): f32 {
  const detunedSaws: f32 = saw(110, t) + saw(111, t)
  const lfo: f32 = tri(0.5, ramp(0.125, t));
  const lfo2: f32 = tri(0.15, ramp(0.125, t)) * 0.7;
  const filtered: f32 = lores2(lfo, lfo2, detunedSaws);
  return filtered * 0.25;
}

// export function createParameters(): Map<string, Float32Array> {
//   return new Map();
// }

// export function parametersGet(config: Map<string, Float32Array>, key: string): Float32Array {
//   return config.get(key);
// }

// export function parametersSet(config: Map<string, Float32Array>, key: string, value: Float32Array): Map<string, Float32Array> {
//   return config.set(key, value);
// }
